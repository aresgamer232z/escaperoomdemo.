<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Escape Room ‚Äì Saxon Possessive</title>
<style>
  :root{
    --bg:#0e0f12; --card:#171a21; --tile:#2a2f3a; --wall:#3a4250; --accent:#6ee7ff;
    --ok:#2ecc71; --bad:#e74c3c; --text:#e9eef6;
  }
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0c0d12,#131621);
  color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 18px;border-bottom:1px solid #242938;display:flex;gap:10px;align-items:center;justify-content:space-between}
  h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
  main{max-width:980px;margin:18px auto;padding:0 12px}
  .row{display:grid;grid-template-columns:1fr 340px;gap:14px}
  @media (max-width:900px){.row{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid #222736;border-radius:16px;box-shadow:0 8px 24px #0006}
  .panel{padding:14px}
  /* HUD */
  .hud{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .badge{background:#1f2430;border:1px solid #2a3140;padding:6px 10px;border-radius:999px;font-size:13px}
  .badge b{color:var(--accent)}
  button{background:#222a38;color:var(--text);border:1px solid #2b3342;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  button:hover{filter:brightness(1.1)}
  .accent{border-color:#2dd4bf}
  /* Grid (mapa) */
  #board{aspect-ratio:1/1;background:#0b0d12;border-radius:16px;margin:10px;display:grid;gap:2px;padding:8px;border:1px solid #1f2531}
  .cell{background:var(--tile);border-radius:6px;position:relative;transition:transform .05s}
  .wall{background:var(--wall)}
  .goal::after{content:"‚¨á Puerta";position:absolute;inset:auto 6px 6px auto;font-size:12px;opacity:.8}
  .player{background:#222;border:2px solid #4ade80;box-shadow:0 0 0 3px #4ade8033 inset;border-radius:8px}
  .hint{outline:2px dashed #ffd166aa}
  /* Modal pregunta */
  dialog{border:none;border-radius:16px;background:#0f1320;color:var(--text);width:min(560px,92%);padding:0}
  dialog::backdrop{background:#000a}
  .q-header{padding:14px 16px;border-bottom:1px solid #1f2533;display:flex;gap:10px;align-items:center}
  .q-body{padding:16px;display:grid;gap:10px}
  .q-hint{font-size:13px;opacity:.9}
  .opt{background:#1a2030;padding:10px;border:1px solid #283044;border-radius:10px;cursor:pointer}
  .opt:hover{filter:brightness(1.05)}
  .ok{border-color:#2ecc71;background:#193123}
  .bad{border-color:#e74c3c;background:#2c1619}
  /* Touch controls */
  .pad{display:grid;grid-template-columns:repeat(3,56px);gap:8px;justify-content:center;padding:12px}
  .pad button{width:56px;height:56px;border-radius:14px}
  .ghost{visibility:hidden}
  /* Start / End */
  .center{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:22px;gap:14px;text-align:center}
  input[type=text]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3140;background:#161b25;color:var(--text)}
  .small{font-size:12px;opacity:.8}
</style>
</head>
<body>
<header>
  <h1>Escape Room ¬∑ Saxon Possessive</h1>
  <div class="hud">
    <span class="badge">Jugador: <b id="hudName">‚Äî</b></span>
    <span class="badge">Nivel: <b id="hudLevel">1/5</b></span>
    <span class="badge">Tiempo: <b id="hudTime">05:00</b></span>
    <span class="badge">Puntos: <b id="hudScore">0</b></span>
  </div>
</header>

<main class="row">
  <!-- Juego -->
  <section class="card">
    <div class="panel">
      <div id="board" aria-label="tablero"></div>
      <div class="pad">
        <span class="ghost"></span>
        <button id="btnUp">‚Üë</button>
        <span class="ghost"></span>
        <button id="btnLeft">‚Üê</button>
        <button id="btnDown">‚Üì</button>
        <button id="btnRight">‚Üí</button>
      </div>
    </div>
  </section>

  <!-- Instrucciones / Estado -->
  <aside class="card">
    <div class="panel">
      <div id="screen"></div>
    </div>
  </aside>
</main>

<!-- Modal de preguntas -->
<dialog id="quiz">
  <div class="q-header">
    <strong>Desbloquea la puerta</strong>
  </div>
  <div class="q-body">
    <div id="qText"></div>
    <div id="qHint" class="q-hint"></div>
    <div id="qOpts"></div>
  </div>
</dialog>

<script>
/* ======= Configuraci√≥n del juego ======= */
const LEVELS = [
  { // Nivel 1 ‚Äì 5:00, -5s penalizaci√≥n
    time: 300, penalty: 5,
    map: [
      "##########",
      "#P......G#",
      "#..##....#",
      "#..##....#",
      "#........#",
      "#..##....#",
      "#..##....#",
      "#....H...#",
      "##########",
      "##########",
    ],
    q:{
      text:"Elige el *genitivo saj√≥n* correcto: the backpack of Maria",
      opts:["Maria's backpack","Marias' backpack","Maria backpack"],
      ok:0, hint:"Regla base: nombre singular + 's ‚Üí posesi√≥n."
    }
  },
  { // Nivel 2 ‚Äì 4:00, -4s
    time: 240, penalty: 4,
    map: [
      "##########",
      "#P...##..#",
      "#....##..#",
      "#..H.....#",
      "#..##....#",
      "#..##G...#",
      "#........#",
      "#........#",
      "##########",
      "##########",
    ],
    q:{
      text:"Plural terminado en *s*: the toys of the kids",
      opts:["the kids' toys","the kid's toys","the kids's toys"],
      ok:0, hint:"Si el plural ya termina en s ‚Üí solo ap√≥strofo al final."
    }
  },
  { // Nivel 3 ‚Äì 3:00, -3s
    time: 180, penalty: 3,
    map: [
      "##########",
      "#P.......#",
      "#.####...#",
      "#....#...#",
      "#.H..#...#",
      "#.##.#...#",
      "#....#G..#",
      "#....#...#",
      "##########",
      "##########",
    ],
    q:{
      text:"Plural irregular: the feet of the men",
      opts:["the men's feet","the mens' feet","the men feet"],
      ok:0, hint:"Plurales irregulares (men, children, people) ‚Üí + 's."
    }
  },
  { // Nivel 4 ‚Äì 2:00, -2s
    time: 120, penalty: 2,
    map: [
      "##########",
      "#P....#..#",
      "#.##..#..#",
      "#.##..#..#",
      "#.H...#..#",
      "#.####...#",
      "#.....G..#",
      "#........#",
      "##########",
      "##########",
    ],
    q:{
      text:"Nombres que terminan en *s*: the car of James",
      opts:["James's car","James' car","Jame's car"],
      ok:0, hint:"En ingl√©s moderno se acepta *'s* para propios en -s."
    }
  },
  { // Nivel 5 ‚Äì 1:00, -1s
    time: 60, penalty: 1,
    map: [
      "##########",
      "#P..##...#",
      "#...##...#",
      "#.H......#",
      "#.#####..#",
      "#.....#..#",
      "#..##.#G.#",
      "#.....#..#",
      "##########",
      "##########",
    ],
    q:{
      text:"Pregunta de *whose*: Completa Whose book is this? It is __. (my sister)_",
      opts:["my sister's","my sisters'","the book of my sister"],
      ok:0, hint:"Con *whose* la respuesta se da con *'s* del poseedor."
    }
  },
];

const TILE_WALL = '#', TILE_EMPTY='.', TILE_PLAYER='P', TILE_GOAL='G', TILE_HINT='H';

/* ======= Estado ======= */
let player={x:1,y:1};
let levelIndex=0;
let score=0;
let timer=null, timeLeft=LEVELS[0].time;
let startedAt=null, finishedAt=null;
let playerName = localStorage.getItem('sp_name') || '';

/* ======= UI ======= */
const board = document.getElementById('board');
const screen = document.getElementById('screen');
const hud = {
  name: document.getElementById('hudName'),
  level: document.getElementById('hudLevel'),
  time: document.getElementById('hudTime'),
  score: document.getElementById('hudScore')
};
const quiz = document.getElementById('quiz');
const qText = document.getElementById('qText');
const qHint = document.getElementById('qHint');
const qOpts = document.getElementById('qOpts');

/* ======= Util ======= */
const fmt = s=> {
  const m = Math.floor(s/60).toString().padStart(2,'0');
  const ss = Math.floor(s%60).toString().padStart(2,'0');
  return ${m}:${ss};
};
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

/* ======= Inicio / Pantallas ======= */
function renderStart(){
  board.innerHTML='';
  const box = document.createElement('div');
  box.className='center';
  box.innerHTML=`
    <h2>Bienvenido/a</h2>
    <p>Mu√©vete con <b>WASD / Flechas</b> o los botones. Llega a la <b>puerta</b> y responde
    la pregunta para abrirla. Toca los <b>cuadros punteados</b> para ver <b>pistas</b>.</p>
    <input id="nameInput" type="text" placeholder="Escribe tu nombre" value="${playerName}"/>
    <button class="accent" id="startBtn">Comenzar</button>
    <p class="small">Niveles: 1) 5:00 ¬∑ 2) 4:00 ¬∑ 3) 3:00 ¬∑ 4) 2:00 ¬∑ 5) 1:00</p>
  `;
  screen.innerHTML='';
  screen.appendChild(box);
  document.getElementById('startBtn').onclick=()=>{
    const v = document.getElementById('nameInput').value.trim() || 'Jugador';
    playerName = v; localStorage.setItem('sp_name', v);
    startGame();
  };
  hud.name.textContent = playerName || '‚Äî';
}
function renderEnd(){
  clearInterval(timer);
  const totalElapsed = Math.max(0, Math.round((finishedAt - startedAt)/1000));
  const box = document.createElement('div');
  box.className='center';
  box.innerHTML = `
    <h2>¬°Escape completado!</h2>
    <p><b>${playerName}</b>, tu puntaje fue <b>${score}</b> y tu tiempo total <b>${fmt(totalElapsed)}</b>.</p>
    <button id="againBtn">Jugar de nuevo</button>
    <p class="small">Tip: usa este resultado para dar puntos extra a quienes terminen primero üòâ</p>
  `;
  screen.innerHTML=''; screen.appendChild(box);
  document.getElementById('againBtn').onclick=()=>{ levelIndex=0; score=0; renderStart(); };
}

/* ======= Motor ======= */
let currentMap=[], rows=0, cols=0;

function loadLevel(idx){
  const L = LEVELS[idx];
  currentMap = L.map.map(r=>r.split(''));
  rows=currentMap.length; cols=currentMap[0].length;

  // tama√±o de la grilla responsivo
  const side = Math.min(720, Math.min(window.innerWidth-40, 720));
  board.style.gridTemplateColumns = repeat(${cols}, 1fr);
  board.innerHTML='';

  // localizar jugador
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      if(currentMap[y][x]==TILE_PLAYER){ player.x=x; player.y=y; }
    }
  }

  // pintar
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      const c = document.createElement('div');
      c.className='cell';
      const t = currentMap[y][x];
      if(t==TILE_WALL) c.classList.add('wall');
      if(t==TILE_GOAL) c.classList.add('goal');
      if(t==TILE_HINT) c.classList.add('hint');
      if(x==player.x&&y==player.y) c.classList.add('player');
      c.dataset.x=x; c.dataset.y=y;
      c.onclick = ()=>touchTile(x,y);
      board.appendChild(c);
    }
  }

  // HUD
  hud.level.textContent = ${idx+1}/${LEVELS.length};
  timeLeft = L.time;
  hud.time.textContent = fmt(timeLeft);
  hud.score.textContent = score;

  // panel lateral
  const help = document.createElement('div');
  help.innerHTML = `
    <h3>Nivel ${idx+1}</h3>
    <ul>
      <li>Tiempo: <b>${fmt(L.time)}</b> | Penalizaci√≥n por error: <b>-${L.penalty}s</b></li>
      <li>Llega a la puerta y responde correctamente.</li>
      <li>Presiona una <b>celda punteada</b> para ver la pista.</li>
    </ul>
  `;
  screen.innerHTML=''; screen.appendChild(help);
}

function startTimer(){
  clearInterval(timer);
  startedAt = startedAt ?? Date.now();
  timer = setInterval(()=>{
    timeLeft--; hud.time.textContent = fmt(timeLeft);
    if(timeLeft<=0){ clearInterval(timer); gameOver(); }
  }, 1000);
}

function startGame(){
  finishedAt=null; startedAt=null;
  score=0; levelIndex=0;
  loadLevel(levelIndex);
  startTimer();
  // foco para teclado en m√≥viles no importa
}

function gameOver(){
  // pantalla de derrota
  const box = document.createElement('div');
  box.className='center';
  box.innerHTML=`
    <h2>Se acab√≥ el tiempo</h2>
    <p>${playerName}, tu puntaje fue <b>${score}</b>. ¬°Int√©ntalo otra vez!</p>
    <button class="accent" id="retryBtn">Reintentar</button>
  `;
  screen.innerHTML=''; screen.appendChild(box);
  document.getElementById('retryBtn').onclick=()=>{ renderStart(); };
}

/* ======= Movimiento ======= */
function canMove(nx,ny){
  nx=clamp(nx,0,cols-1); ny=clamp(ny,0,rows-1);
  return currentMap[ny][nx]!==TILE_WALL;
}
function move(dx,dy){
  const nx = clamp(player.x+dx,0,cols-1);
  const ny = clamp(player.y+dy,0,rows-1);
  if(!canMove(nx,ny)) return;
  const oldIndex = player.y*cols+player.x;
  const newIndex = ny*cols+nx;
  board.children[oldIndex].classList.remove('player');
  board.children[newIndex].classList.add('player');
  player.x=nx; player.y=ny;

  const tile = currentMap[ny][nx];
  if(tile===TILE_GOAL){
    askQuestion();
  }
}
function touchTile(x,y){
  const t = currentMap[y][x];
  if(t===TILE_HINT){
    showHint();
  }
  if(Math.abs(x-player.x)+Math.abs(y-player.y)===1){
    move(x-player.x, y-player.y);
  }
}

document.addEventListener('keydown',e=>{
  const k = e.key.toLowerCase();
  if(["arrowup","w"].includes(k)) move(0,-1);
  else if(["arrowdown","s"].includes(k)) move(0,1);
  else if(["arrowleft","a"].includes(k)) move(-1,0);
  else if(["arrowright","d"].includes(k)) move(1,0);
});

document.getElementById('btnUp').onclick=()=>move(0,-1);
document.getElementById('btnDown').onclick=()=>move(0,1);
document.getElementById('btnLeft').onclick=()=>move(-1,0);
document.getElementById('btnRight').onclick=()=>move(1,0);

/* ======= Preguntas / pistas ======= */
function askQuestion(){
  const L = LEVELS[levelIndex];
  qText.innerHTML = <p>${L.q.text}</p>;
  qHint.textContent = "";
  qOpts.innerHTML = "";
  L.q.opts.forEach((op,i)=>{
    const b = document.createElement('button');
    b.className='opt';
    b.textContent = op;
    b.onclick = ()=>{
      if(i===L.q.ok){
        b.classList.add('ok');
        score += 100;
        hud.score.textContent = score;
        setTimeout(nextLevel, 500);
        quiz.close();
      }else{
        b.classList.add('bad');
        timeLeft = Math.max(0, timeLeft - L.penalty);
        hud.time.textContent = fmt(timeLeft);
      }
    };
    qOpts.appendChild(b);
  });
  quiz.showModal();
}
function showHint(){
  const L = LEVELS[levelIndex];
  qText.innerHTML = <p>${L.q.text}</p>;
  qHint.textContent = "Pista: " + L.q.hint;
  qOpts.innerHTML = "";
  const b = document.createElement('button');
  b.textContent = "Cerrar";
  b.onclick = ()=>quiz.close();
  qOpts.appendChild(b);
  quiz.showModal();
}

function nextLevel(){
  levelIndex++;
  if(levelIndex>=LEVELS.length){
    finishedAt = Date.now();
    renderEnd(); return;
  }
  loadLevel(levelIndex);
}

/* ======= Boot ======= */
renderStart();
</script>
</body>
</html>
